<%+header%>
<link rel="stylesheet" href="<%=resource%>/css/common.css">
<script src="<%=resource%>/jquery-3.7.1.min.js"></script>
<script src="<%=resource%>/common.js"></script>
<%+fwx_network/common_style%>
<div class="fwx-form-card">
  <div class="form-title"><%:Dashboard Setting%></div>
  <div class="form-desc"><%:Configure dashboard monitoring interface%></div>

  <div class="form-row">
    <label class="form-label"><%:Traffic Statistics Interface%></label>
    <select id="monitor-device">
    </select>
  </div>

  <div class="form-row" style="justify-content:flex-end; gap:8px;">
    <button class="btn btn-secondary" id="setting-refresh"><%:Refresh%></button>
    <button class="btn" id="setting-save"><%:Save%></button>
  </div>
  <div class="status-tip" id="setting-tip"></div>
</div>

<script>
(function(){
  var _SavedSuccessfully = '<%:Saved successfully%>';
  var _SaveFailed = '<%:Save failed%>';
  var _Loading = '<%:Loading...%>';
  var _LoadFailed = '<%:Load failed%>';
  
  const apiGetDeviceList = '<%=url("admin/fwx/get_device_list")%>';
  const apiGet = '<%=url("admin/fwx/get_dashboard_param")%>';
  const apiSet = '<%=url("admin/fwx/set_dashboard_param")%>';

  function showModal(msg, ok) {
    if (ok) {
      showCommonModal(msg, 2000, 'success');
    } else {
      showCommonModal(msg, 2000, 'error');
    }
  }

  function loadDeviceList() {
    $.getJSON(apiGetDeviceList, function(resp){
      if(resp && resp.code === 2000 && resp.data && resp.data.device_list) {
        const deviceList = resp.data.device_list;
        const $select = $('#monitor-device');
        $select.empty();
        
        if(Array.isArray(deviceList)) {
          deviceList.forEach(function(device) {
            const value = typeof device === 'string' ? device : (device.value || device.name || device);
            $select.append($('<option>').val(value).text(value));
          });
        }
        
        refresh();
      } else {
        $('#setting-tip').text(_LoadFailed);
      }
    }).fail(function(){
      $('#setting-tip').text(_LoadFailed);
    });
  }

  function refresh() {
    $('#setting-tip').text(_Loading);
    $.getJSON(apiGet, function(resp){
      const d = (resp && resp.data) || {};
      const monitorDevice = d.monitor_device || '';
      $('#monitor-device').val(monitorDevice);
      $('#setting-tip').text('');
    }).fail(function(){
      $('#setting-tip').text(_LoadFailed);
    });
  }

  function save() {
    const payload = { monitor_device: $('#monitor-device').val() || '' };
    $('#setting-save').prop('disabled', true);
    $.ajax({
      url: apiSet,
      method: 'POST',
      data: payload
    }).done(function(resp){
      if (resp && (resp.code === 0 || resp.code === 2000)) {
        showModal(_SavedSuccessfully, true);
      } else {
        showModal(_SaveFailed, false);
      }
    }).fail(function(){
      showModal(_SaveFailed, false);
    }).always(function(){
      $('#setting-save').prop('disabled', false);
    });
  }

  $('#setting-refresh').on('click', loadDeviceList);
  $('#setting-save').on('click', save);
  $(loadDeviceList);
})();
</script>
<%+footer%>

