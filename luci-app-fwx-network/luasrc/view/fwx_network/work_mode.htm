<%+header%>
<link rel="stylesheet" href="<%=resource%>/css/common.css">
<script src="<%=resource%>/jquery-3.7.1.min.js"></script>
<script src="<%=resource%>/common.js"></script>
<%+fwx_network/common_style%>
<div class="fwx-form-card">
  <div class="form-title"><%:Work Mode%></div>
  <div class="form-desc"><%:Work mode affects behavior management and Internet audit. Please select the correct mode. Note that downstream traffic cannot be counted in bypass mode.%></div>

  <div class="form-row">
    <label class="form-label"><%:Work Mode%></label>
    <select id="work-mode">
      <option value="0"><%:Gateway Mode%></option>
      <option value="1"><%:Bypass Mode%></option>
    </select>
  </div>

  <div class="form-row" style="justify-content:flex-end; gap:8px;">
    <button class="btn btn-secondary" id="wm-refresh"><%:Refresh%></button>
    <button class="btn" id="wm-save"><%:Save%></button>
  </div>
  <div class="status-tip" id="wm-tip"></div>
</div>

<script>
(function(){
  var _SavedSuccessfully = '<%:Saved successfully%>';
  var _SaveFailed = '<%:Save failed%>';
  var _Loading = '<%:Loading...%>';
  var _LoadFailed = '<%:Load failed%>';
  
  const apiGet = '<%=url("admin/fwx_network/get_work_mode")%>';
  const apiSet = '<%=url("admin/fwx_network/set_work_mode")%>';

  function showModal(msg, ok) {
    if (ok) {
      showCommonModal(msg, 2000, 'success');
    } else {
      showCommonModal(msg, 2000, 'error');
    }
  }

  function refresh() {
    $('#wm-tip').text(_Loading);
    $.getJSON(apiGet, function(resp){
      const d = (resp && resp.data) || {};
      $('#work-mode').val((d.work_mode === 1) ? "1" : "0");
      $('#wm-tip').text('');
    }).fail(function(){
      $('#wm-tip').text(_LoadFailed);
    });
  }

  function save() {
    const payload = { work_mode: $('#work-mode').val() || "0" };
    $('#wm-save').prop('disabled', true);
    $.ajax({
      url: apiSet,
      method: 'POST',
      data: payload
    }).done(function(resp){
      if (resp && (resp.code === 0 || resp.code === 2000)) {
        showModal(_SavedSuccessfully, true);
      } else {
        showModal(_SaveFailed, false);
      }
    }).fail(function(){
      showModal(_SaveFailed, false);
    }).always(function(){
      $('#wm-save').prop('disabled', false);
    });
  }

  $('#wm-refresh').on('click', refresh);
  $('#wm-save').on('click', save);
  $(refresh);
})();
</script>
<%+footer%>

