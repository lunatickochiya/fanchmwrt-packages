<%+header%>
<link rel="stylesheet" href="<%=resource%>/css/common.css">
<script src="<%=resource%>/jquery-3.7.1.min.js"></script>
<script src="<%=resource%>/common.js"></script>
<%+fwx_network/common_style%>
<div class="fwx-form-card">
  <div class="form-title"><%:WAN Settings%></div>
  <div class="form-desc"><%:Configure default WAN interface%></div>

  <div class="form-row">
    <label class="form-label"><%:Protocol%></label>
    <select id="wan-proto">
      <option value="dhcp"><%:DHCP%></option>
      <option value="static"><%:Static%></option>
      <option value="pppoe"><%:PPPoE%></option>
    </select>
  </div>

  <div id="wan-static-config">
    <div class="form-row">
      <label class="form-label"><%:IP Address%></label>
      <div style="flex: 1;">
        <input id="wan-ip" type="text" placeholder="">
        <div class="error-msg" id="wan-ip-error" style="display:none; color:#f87171; font-size:12px; margin-top:4px;"></div>
      </div>
    </div>
    <div class="form-row">
      <label class="form-label"><%:Netmask%></label>
      <div style="flex: 1;">
        <input id="wan-mask" type="text" placeholder="">
        <div class="error-msg" id="wan-mask-error" style="display:none; color:#f87171; font-size:12px; margin-top:4px;"></div>
      </div>
    </div>
    <div class="form-row">
      <label class="form-label"><%:Gateway%></label>
      <div style="flex: 1;">
        <input id="wan-gw" type="text" placeholder="">
        <div class="error-msg" id="wan-gw-error" style="display:none; color:#f87171; font-size:12px; margin-top:4px;"></div>
      </div>
    </div>
    <div class="form-row">
      <label class="form-label">DNS1</label>
      <div style="flex: 1;">
        <input id="wan-dns1" type="text" placeholder="">
        <div class="error-msg" id="wan-dns1-error" style="display:none; color:#f87171; font-size:12px; margin-top:4px;"></div>
      </div>
    </div>
    <div class="form-row">
      <label class="form-label">DNS2</label>
      <div style="flex: 1;">
        <input id="wan-dns2" type="text" placeholder="" disabled>
        <div class="error-msg" id="wan-dns2-error" style="display:none; color:#f87171; font-size:12px; margin-top:4px;"></div>
      </div>
    </div>
  </div>

  <div id="wan-pppoe-config" style="display:none;">
    <div class="form-row">
      <label class="form-label"><%:Username%></label>
      <div style="flex: 1;">
        <input id="wan-username" type="text" placeholder="" maxlength="64">
        <div class="error-msg" id="wan-username-error" style="display:none; color:#f87171; font-size:12px; margin-top:4px;"></div>
      </div>
    </div>
    <div class="form-row">
      <label class="form-label"><%:Password%></label>
      <div style="flex: 1;">
        <input id="wan-password" type="password" placeholder="" maxlength="64">
        <div class="error-msg" id="wan-password-error" style="display:none; color:#f87171; font-size:12px; margin-top:4px;"></div>
      </div>
    </div>
  </div>

  <div class="form-row" style="justify-content:flex-end; gap:8px;">
    <button class="btn btn-secondary" id="wan-refresh"><%:Refresh%></button>
    <button class="btn" id="wan-save"><%:Save%></button>
  </div>
  <div class="status-tip" id="wan-tip"></div>
</div>

<script>
(function(){
  var _SavedSuccessfully = '<%:Saved successfully%>';
  var _SaveFailed = '<%:Save failed%>';
  var _Loading = '<%:Loading...%>';
  var _LoadFailed = '<%:Load failed%>';
  var _InvalidIP = '<%:Invalid IP address%>';
  var _InvalidNetmask = '<%:Invalid netmask%>';
  var _InvalidGateway = '<%:Invalid gateway%>';
  var _InvalidDNS = '<%:Invalid DNS address%>';
  var _DNS1Required = '<%:DNS1 must be set before DNS2%>';
  var _UsernameRequired = '<%:Username is required%>';
  var _PasswordRequired = '<%:Password is required%>';
  
  const apiGet = '<%=url("admin/fwx_network/get_wan_info")%>';
  const apiSet = '<%=url("admin/fwx_network/set_wan_info")%>';

  function showModal(msg, ok) {
    if (ok) {
      showCommonModal(msg, 2000, 'success');
    } else {
      showCommonModal(msg, 2000, 'error');
    }
  }

  function showError(fieldId, errorMsg) {
    $('#' + fieldId + '-error').text(errorMsg).show();
    $('#' + fieldId).css('border-color', '#f87171');
  }

  function clearError(fieldId) {
    $('#' + fieldId + '-error').hide();
    $('#' + fieldId).css('border-color', '');
  }

  function validateField(fieldId, validator, errorMsg) {
    const value = $('#' + fieldId).val();
    if (value && !validator(value)) {
      showError(fieldId, errorMsg);
      return false;
    } else {
      clearError(fieldId);
      return true;
    }
  }

  function validateRequired(fieldId, errorMsg) {
    const value = $('#' + fieldId).val();
    if (!value || value.trim() === '') {
      showError(fieldId, errorMsg);
      return false;
    } else {
      clearError(fieldId);
      return true;
    }
  }

  function toggleConfigSections() {
    const proto = $('#wan-proto').val();
    if (proto === 'static') {
      $('#wan-static-config').show();
      $('#wan-pppoe-config').hide();
    } else if (proto === 'pppoe') {
      $('#wan-static-config').hide();
      $('#wan-pppoe-config').show();
    } else {
      $('#wan-static-config').hide();
      $('#wan-pppoe-config').hide();
    }
  }

  function toggleDNS2() {
    const dns1 = $('#wan-dns1').val();
    if (dns1 && dns1.trim() !== '') {
      $('#wan-dns2').prop('disabled', false);
      clearError('wan-dns2');
    } else {
      $('#wan-dns2').prop('disabled', true).val('');
      clearError('wan-dns2');
    }
  }

  function render(data) {
    const d = (data && data.data) || {};
    $('#wan-proto').val(d.proto || 'dhcp');
    $('#wan-ip').val(d.ipaddr || '');
    $('#wan-mask').val(d.netmask || '');
    $('#wan-gw').val(d.gateway || '');
    $('#wan-dns1').val(d.dns1 || '');
    $('#wan-dns2').val(d.dns2 || '');
    $('#wan-username').val(d.username || '');
    $('#wan-password').val(d.password || '');

    toggleConfigSections();
    toggleDNS2();
  }

  function refresh() {
    $('#wan-tip').text(_Loading);
    $.getJSON(apiGet, function(resp){
      render(resp);
      $('#wan-tip').text('');
    }).fail(function(){
      $('#wan-tip').text(_LoadFailed);
    });
  }

  function save() {
    const proto = $('#wan-proto').val();
    let isValid = true;

    if (proto === 'static') {
      isValid = validateField('wan-ip', validateIP, _InvalidIP) && isValid;
      isValid = validateField('wan-mask', validateNetmask, _InvalidNetmask) && isValid;
      isValid = validateField('wan-gw', validateIP, _InvalidGateway) && isValid;
      isValid = validateField('wan-dns1', validateIP, _InvalidDNS) && isValid;
      
      const dns1 = $('#wan-dns1').val();
      const dns2 = $('#wan-dns2').val();
      if ((!dns1 || dns1.trim() === '') && dns2 && dns2.trim() !== '') {
        showError('wan-dns2', _DNS1Required);
        isValid = false;
      } else {
        isValid = validateField('wan-dns2', validateIP, _InvalidDNS) && isValid;
      }
    } else if (proto === 'pppoe') {
      isValid = validateRequired('wan-username', _UsernameRequired) && isValid;
      isValid = validateRequired('wan-password', _PasswordRequired) && isValid;
    }

    if (!isValid) {
      return;
    }

    const payload = {
      proto: proto
    };

    if (proto === 'static') {
      payload.ipaddr = $('#wan-ip').val();
      payload.netmask = $('#wan-mask').val();
      payload.gateway = $('#wan-gw').val();
      payload.dns1 = $('#wan-dns1').val();
      payload.dns2 = $('#wan-dns2').val();
    } else if (proto === 'pppoe') {
      payload.username = $('#wan-username').val();
      payload.password = $('#wan-password').val();
    }

    $('#wan-save').prop('disabled', true);
    $.ajax({
      url: apiSet,
      method: 'POST',
      data: payload
    }).done(function(resp){
      if (resp && (resp.code === 0 || resp.code === 2000)) {
        showModal(_SavedSuccessfully, true);
        refresh();
      } else {
        showModal(_SaveFailed, false);
      }
    }).fail(function(){
      showModal(_SaveFailed, false);
    }).always(function(){
      $('#wan-save').prop('disabled', false);
    });
  }

  $('#wan-proto').on('change', toggleConfigSections);
  $('#wan-ip').on('blur', function() { validateField('wan-ip', validateIP, _InvalidIP); });
  $('#wan-mask').on('blur', function() { validateField('wan-mask', validateNetmask, _InvalidNetmask); });
  $('#wan-gw').on('blur', function() { validateField('wan-gw', validateIP, _InvalidGateway); });
  $('#wan-dns1').on('blur', function() {
    validateField('wan-dns1', validateIP, _InvalidDNS);
    toggleDNS2();
  });
  $('#wan-dns2').on('blur', function() { validateField('wan-dns2', validateIP, _InvalidDNS); });
  $('#wan-username').on('blur', function() { validateRequired('wan-username', _UsernameRequired); });
  $('#wan-password').on('blur', function() { validateRequired('wan-password', _PasswordRequired); });

  $('#wan-refresh').on('click', refresh);
  $('#wan-save').on('click', save);
  $(refresh);
})();
</script>
<%+footer%>

