<link rel="stylesheet" href="<%=resource%>/css/common.css">
<script type="text/javascript" src="<%=resource%>/jquery-3.7.1.min.js"></script>

<div class="feature-container">
	<ul class="tab-list cbi-tabmenu">
		<li class="tab-item cbi-tab active" data-tab="tab-basic"><%:Basic Info%></li>
		<li class="tab-item cbi-tab" data-tab="tab-apps"><%:App List%></li>
	</ul>

	<div class="cbi-tabcontainer">
	<div id="tab-basic" class="tab-body active cbi-tab">
		<div id="feature-info" class="feature-info-card">
			<div class="feature-info-grid">
				<div class="feature-info-item">
					<span class="feature-info-label"><%:Current version%></span>
					<span class="feature-info-value" id="info-version">--</span>
				</div>
				<div class="feature-info-item">
					<span class="feature-info-label"><%:Feature format%></span>
					<span class="feature-info-value" id="info-format">--</span>
				</div>
				<div class="feature-info-item">
					<span class="feature-info-label"><%:App number%></span>
					<span class="feature-info-value" id="info-appnum">--</span>
				</div>
				<div class="feature-info-item">
					<span class="feature-info-label"><%:Feature download%></span>
					<span class="feature-info-value"><a href="http://www.openappfilter.com" target="_blank">www.openappfilter.com</a></span>
				</div>
			</div>


		<div class="feature-card">
			<div class="feature-row">
				<label class="feature-label" for="ulfile"><%:Feature Upgrade:%></label>
				<div class="feature-inputs">
					<input class="cbi-input-file feature-file" type="file" id="ulfile" name="ulfile" />
					<input type="submit" class="cbi-button cbi-input-apply feature-btn" name="upload" value="<%:Upload%>" onclick="startUpgradeStatusPoll(); return true;"/>
				</div>
			</div>
			<div class="feature-hint" id="upload-hint">
				<%:You can download the feature library from the website(www.openappfilter.com),then upload it here.%>
			</div>
			<div class="feature-status" id="upgrade-status" style="display:none;"></div>
		</div>
		

		</div>

	</div>

	</div>

	<div id="tab-apps" class="tab-body cbi-tab">
		<div id="app-list" class="app-list"></div>
	</div>
	</div>
</div>

<div id="modal" class="feature-modal">
	<div class="feature-modal-content">
		<p><%:Updating, please wait...%></p>
	</div>
</div>

<style>
.feature-container { padding: 10px; }
.tab-list { display: flex; list-style: none; padding: 0; margin: 10px 0 15px 0; border-bottom: 1px solid rgba(255,255,255,0.1);}
.tab-item { padding: 6px 14px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); border-bottom: none; margin-right: 6px; border-radius: 6px 6px 0 0; background: #1e1e1e; color: #ccc; }
.tab-item.active { background: #2d2d2d; color: #fff; font-weight: 600; }
.tab-body { display: none; }
.tab-body.active { display: block; }
.feature-info-card{padding:16px;border:1px solid rgba(255,255,255,0.08);border-radius:8px;background:rgba(255,255,255,0.03);margin-bottom:12px;}
.feature-info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;}
.feature-info-item{padding:10px 12px;border:1px solid rgba(255,255,255,0.05);border-radius:6px;background:rgba(255,255,255,0.02);}
.feature-info-label{display:block;font-size:13px;color:#9ca3af;margin-bottom:4px;}
.feature-info-value{font-weight:600;font-size:15px;}
.feature-card {background: rgba(255,255,255,0.03);border: 1px solid rgba(255,255,255,0.08);border-radius: 8px;padding: 16px;margin-top: 12px;}
.feature-row {display: flex;align-items: center;gap: 12px;flex-wrap: wrap;}
.feature-label {min-width: 120px;font-weight: 600;}
.feature-inputs {display: flex;align-items: center;gap: 10px;flex: 1;}
.feature-file {width: 100%;max-width: 360px;}
.feature-btn {min-width: 110px;}
.feature-hint {margin-top: 10px;color: #9ca3af;font-size: 13px;line-height: 1.5;}
.feature-status {margin-top: 8px;font-size: 14px;font-weight: 600;}
.feature-status.success {color: #34d399;}
.feature-status.error {color: #f87171;}
.feature-modal {display: none;position: fixed;top: 0; left: 0; right: 0; bottom: 0;background-color: rgba(0, 0, 0, 0.5);z-index: 1000;justify-content: center;align-items: center;}
.feature-modal-content {background: rgba(34,34,34,0.9);padding: 16px 20px;border-radius: 6px;color: #fff;min-width: 200px;text-align: center;box-shadow: 0 4px 12px rgba(0,0,0,0.4);}
.app-list {margin-top: 10px;}
.class-card {margin-bottom: 16px;border:1px solid rgba(255,255,255,0.08);border-radius:8px;background:rgba(255,255,255,0.03);}
.class-header {padding:12px 16px;font-weight:600;font-size:15px;border-bottom:1px solid rgba(255,255,255,0.08);color:#fff;}
.app-items {display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:12px 16px;}
.app-item {display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid rgba(255,255,255,0.1);border-radius:6px;background:rgba(255,255,255,0.02);font-size:13px;cursor:default;transition:all 0.2s ease;}
.app-item:hover {background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.2);transform:translateY(-1px);}
.app-item img {width:20px;height:20px;object-fit:contain;border-radius:4px;}
.app-item span {color:#ccc;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100px;}
@media (min-width: 800px) {
	.app-items {grid-template-columns:repeat(6,1fr);}
}
@media (min-width: 1200px) {
	.app-items {grid-template-columns:repeat(8,1fr);}
}
</style>

<script>
    function showModal() {
        var $modal = $('#modal');
        $modal.css('display', 'flex'); 

        setTimeout(function() {
            $modal.css('display', 'none'); 
        }, 15000);
    }

	function showToast(msg, type) {
		var $hint = $('#upload-hint');
		$hint.text(msg || '');
		$hint.removeClass('text-error text-success');
		if (type === 'error') {
			$hint.addClass('text-error');
		} else if (type === 'success') {
			$hint.addClass('text-success');
		}
	}

var pollTimer = null;
var pollTimeout = null;
var classListLoaded = false;

	function stopPoll() {
		if (pollTimer) {
			clearInterval(pollTimer);
			pollTimer = null;
		}
		if (pollTimeout) {
			clearTimeout(pollTimeout);
			pollTimeout = null;
		}
	}

	function hideModal() {
		$('#modal').css('display', 'none');
	}

	function showModal() {
		var $modal = $('#modal');
		$modal.css('display', 'flex');
	}

	function statusMessage(status) {
		if (status === 200) return '<%:Update the feature file successfully%>';
		if (status === 401) return '<%:Failed to update feature file, format error%>';
		if (status === 402) return '<%:Failed to update feature file%> (<%:File too large%>)';
		if (status === 1) return '<%:Updating, please wait...%>';
		return '<%:Failed to update feature file%>';
	}

	function renderUpgradeStatus(status) {
		var $box = $('#upgrade-status');
		if (!status || status === 0) {
			$box.hide().text('').removeClass('success error');
			return;
		}
		var msg = statusMessage(status);
		$box.text(msg).show();
		$box.removeClass('success error');
		if (status === 200) {
			$box.addClass('success');
		} else {
			$box.addClass('error');
		}
	}

	function fetchUpgradeStatusOnce() {
		$.get('<%=url("admin/advance/fwx_feature/upgrade_status")%>', function(resp) {
			var status = (resp && resp.status) ? resp.status : 0;
			renderUpgradeStatus(status);
		});
	}

	function startUpgradeStatusPoll() {
		showModal();
		pollTimeout = setTimeout(function() {
			stopPoll();
			hideModal();
		}, 60000);
	}

	$(function() {
		$('.tab-item').on('click', function() {
			const tabId = $(this).data('tab');
			$('.tab-item').removeClass('active');
			$(this).addClass('active');
			$('.tab-body').removeClass('active');
			$('#' + tabId).addClass('active');
			
			if (tabId === 'tab-apps' && !classListLoaded) {
				loadClassList();
			}
			
			if (tabId === 'tab-apps') {
				setTimeout(function() {
					updateAppItemsColumns();
				}, 100);
			}
		});

		fetchUpgradeStatusOnce();
		loadClassList();

		var resizeTimer;
		$(window).on('resize', function() {
			clearTimeout(resizeTimer);
			resizeTimer = setTimeout(function() {
				if ($('#tab-apps').hasClass('active')) {
					updateAppItemsColumns();
				}
			}, 200);
		});

		loadFeatureInfo();
	});

	function loadFeatureInfo() {
		new XHR().get('<%=url("admin/advance/fwx_feature/info")%>', null, function(x, data) {
			if (data && data.code === 0 && data.data) {
				$('#info-version').text(data.data.version || '--');
				$('#info-format').text(data.data.format || '--');
				$('#info-appnum').text(data.data.app_count || 0);
			}
		});
	}

	function loadClassList() {
		$.get('<%=url("admin/advance/fwx_feature/class_list")%>', function(data) {
			var list = [];
			if (data && data.class_list) {
				list = data.class_list;
			} else if (data && data.data && Array.isArray(data.data)) {
				list = data.data;
			} else if (data && data.classes && Array.isArray(data.classes)) {
				list = data.classes;
			}
			renderClassList(list);
			classListLoaded = true;
		}).fail(function() {
			$('#app-list').html('<div class="feature-hint"><%:Failed to load app list%></div>');
		});
	}

	function updateAppItemsColumns() {
		var containerWidth = $('.feature-container').width() || $(window).width();
		var $appItems = $('.app-items');

		var cols = 4; 
		if (containerWidth >= 1200) {
			cols = 8; 
		} else if (containerWidth >= 800) {
			cols = 6; 
		}

		$appItems.css('grid-template-columns', 'repeat(' + cols + ', 1fr)');
	}

	function renderClassList(list) {
		const $container = $('#app-list');
		$container.empty();
		
		if (!list || list.length === 0) {
			$container.append('<div class="feature-hint"><%:No data%></div>');
			return;
		}
		
		list.forEach(function(category) {
			const appList = category.app_list || [];
			const $card = $('<div class="class-card"></div>');
			const categoryName = category.name || ('Class ' + (category.id || ''));
			const appCount = appList.length;
			$card.append('<div class="class-header">' + categoryName + ' (' + appCount + ')</div>');
			
			const $apps = $('<div class="app-items"></div>');
			
			if (appList.length === 0) {
				$apps.append('<div class="feature-hint"><%:No apps%></div>');
			} else {
				appList.forEach(function(app) {
					var parts = app.split(',');
					var appId = parts[0] || '';
					var appName = parts[1] || 'Unknown';
					var hasIcon = parts[2] === '1';
					
					var $appItem = $('<div class="app-item"></div>');
					
					var iconSrc = hasIcon ? '<%=resource%>/app_icons/' + appId + '.png' : '<%=resource%>/app_icons/default.png';
					var $icon = $('<img>').attr({
						src: iconSrc,
						alt: appName,
						onerror: 'this.src="<%=resource%>/app_icons/default.png"'
					});
					
					var $name = $('<span></span>').text(appName);
					
					$appItem.append($icon).append($name);
					$apps.append($appItem);
				});
			}
			
			$card.append($apps);
			$container.append($card);
		});
		
		setTimeout(function() {
			updateAppItemsColumns();
		}, 100);
	}
</script>

